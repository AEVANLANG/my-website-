<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Access</title>
  <style>
    :root{
      --bg:#f7f7f8;           /* matte white background */
      --dots:#e5e7eb;         /* moving dots color */
      --panel:#ffffff;        /* keypad panel */
      --panel-edge:#eef0f3;   /* subtle edge for contrast */
      --key:#ffffff;          /* key color */
      --key-edge:#e9ecf1;     /* key edge */
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --press:0 6px 18px rgba(0,0,0,.10);
      --accent:#0ea5e9;       /* success ring */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:#111827;
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      display:grid;
      place-items:center;
      overflow:hidden;
      position:relative;
    }

    /* moving dot pattern background */
    .bg-dots::before, .bg-dots::after{
      content:"";
      position:absolute; inset:-20vmax;
      background:
        radial-gradient(circle 2px at 10px 10px, var(--dots) 99%, transparent 100%)
        0 0/40px 40px;
      filter:blur(.2px);
      opacity:.75;
      animation: drift 30s linear infinite;
      z-index:-2;
    }
    .bg-dots::after{
      opacity:.35;
      transform:scale(1.2);
      animation-duration: 55s;
      animation-direction: reverse;
    }
    @keyframes drift{
      from{ transform: translate3d(0,0,0) }
      to  { transform: translate3d(80px,60px,0) }
    }

    .wrap{
      width:min(92vw,480px);
      aspect-ratio: 1 / 1.25;
      max-height: 86vh;
      background:linear-gradient(180deg,var(--panel),var(--panel)) padding-box,
                 linear-gradient(180deg,var(--panel-edge),transparent) border-box;
      border:1px solid transparent;
      border-radius:28px;
      box-shadow:var(--shadow);
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:8px;
      position:relative;
    }

    .top{
      padding:22px 22px 0;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
    }
    .lock{
      width:22px; height:22px; position:relative;
      border:2px solid #cbd5e1; border-radius:6px; margin-top:10px;
    }
    .lock::before{ /* shackle */
      content:""; position:absolute; left:50%; transform:translateX(-50%);
      top:-14px; width:20px; height:18px; border:2px solid #cbd5e1; border-bottom:none; border-radius:14px 14px 0 0;
    }

    .hint{ font-size:14px; color:#6b7280; text-align:center; padding:0 18px 0 }

    .keys{
      padding:16px 18px 24px; display:grid;
      grid-template-columns: repeat(3, 1fr);
      grid-auto-rows: 1fr;
      gap:14px;
    }

    button.key{
      appearance:none; border:none; background:linear-gradient(180deg,var(--key),var(--key)) padding-box,
                                 linear-gradient(180deg,var(--key-edge),transparent) border-box;
      border:1px solid transparent;
      border-radius:18px;
      box-shadow:var(--shadow);
      font-size:clamp(20px,4.5vw,28px);
      font-weight:700; color:#111827;
      cursor:pointer; user-select:none;
      transition: transform .06s ease, box-shadow .06s ease;
      position:relative;
      display:flex; align-items:center; justify-content:center;
      padding:14px 0;
    }
    button.key:active{
      transform: translateY(2px) scale(.98);
      box-shadow:var(--press);
    }

    .footer{ display:flex; align-items:center; justify-content:center; padding:0 20px 18px; }

    .success{
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;
      opacity:0; transition:opacity .18s ease-out;
    }
    .success.show{ opacity:1; }
    .ring{ width:30vmin; height:30vmin; max-width:320px; max-height:320px; border-radius:50%;
      border:6px solid var(--accent); box-shadow:0 0 0 6px rgba(14,165,233,.18);
      animation: pop 700ms cubic-bezier(.2,.8,.2,1) forwards; background:rgba(14,165,233,.06);
    }
    @keyframes pop{ from{ transform:scale(.6); opacity:.5 } to{ transform:scale(1.12); opacity:1 } }
  </style>
</head>
<body class="bg-dots">
  <div class="wrap" id="wrap">
    <div class="top">
      <div class="lock" aria-hidden="true"></div>
    </div>
    <p class="hint" aria-live="polite">Enter the secret sequence.</p>

    <div class="keys" id="keys" aria-label="Numeric keypad" role="group">
      <!-- JS will fill these -->
    </div>

    <div class="footer"></div>
    <div class="success" id="success" aria-hidden="true"><div class="ring"></div></div>
  </div>

  <script>
    const WORKER_URL = "https://sparkling-glitter-f8bb.philipdhayman.workers.dev";
    const PANEL_URL  = "/panel.html"; // landing page

    const keysContainer = document.getElementById('keys');
    const successOverlay = document.getElementById('success');
    const wrap = document.getElementById('wrap');

    const layout = [1,2,3,4,5,6,7,8,9,'',0,''];
    layout.forEach(v => {
      const btn = document.createElement('button');
      btn.className = 'key';
      btn.type = 'button';
      if (v === '') {
        btn.disabled = true;
        btn.style.visibility = 'hidden';
      } else {
        btn.textContent = v;
        btn.setAttribute('aria-label', `Digit ${v}`);
        btn.addEventListener('click', () => press(String(v)));
      }
      keysContainer.appendChild(btn);
    });

    let buffer = "";
    let busy = false;
    const MIN_DELAY = 120;
    let lastSend = 0;

    async function press(n){
      buffer += n;
      if (buffer.length < 4) return;
      const last4 = buffer.slice(-4);
      const now = Date.now();
      if (busy || (now - lastSend) < MIN_DELAY) return;
      busy = true; lastSend = now;
      try {
        const res = await fetch(WORKER_URL+"/api/enter", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: last4 })
        });
        const data = await res.json().catch(() => ({ ok:false }));
        if (data && data.ok) {
          unlock();
        }
      } catch (e) {
      } finally {
        busy = false;
      }
    }

    async function unlock(){
      try {
        const res = await fetch(WORKER_URL+"/api/ticket", { method: 'POST' });
        const data = await res.json();
        if (data && data.ok && data.ticket) {
          successOverlay.classList.add('show');
          wrap.style.filter = 'blur(1px)';
          setTimeout(() => {
            const url = new URL(PANEL_URL, window.location.origin);
            url.searchParams.set('ticket', data.ticket);
            window.location.href = url.toString();
          }, 720);
          return;
        }
      } catch(_){}
    }

    window.addEventListener('keydown', (e) => {
      if (e.key >= '0' && e.key <= '9') press(e.key);
    }, { passive:true });
  </script>
</body>
</html>
